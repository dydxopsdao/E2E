name: E2E Pipeline

on:
  workflow_dispatch:
    inputs:
      deployment_id:
        description: 'Deployment ID'
        required: false
        default: 'manual'
  pull_request:

permissions:
  contents: read

env:
  APPLITOOLS_API_KEY:    ${{ secrets.APPLITOOLS_API_KEY }}
  APPLITOOLS_SERVER_URL: https://eyesapi.applitools.com
  S3_TRACE_BUCKET:       ${{ secrets.S3_TRACE_BUCKET }}
  AWS_DEFAULT_REGION:    ${{ secrets.AWS_DEFAULT_REGION }}
  SLACK_BOT_TOKEN:       ${{ secrets.SLACK_BOT_TOKEN }}

jobs:
  e2e-test:
    name: "E2E Tests (Deployment: ${{ inputs.deployment_id }})"
    runs-on: self-hosted

    env:
      APPLITOOLS_BATCH_ID: ${{ github.event.pull_request.head.sha || github.sha }}
      RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
      SLACK_CHANNEL: "${{ inputs.deployment_id == 'manual' && 'C08GBVA4JKT' || 'C07VDF07WLU' }}"
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      NORDLAYER_EMAIL: ${{ secrets.NORDLAYER_EMAIL }}
      NORDLAYER_PASSWORD: ${{ secrets.NORDLAYER_PASSWORD }}
      SEED_PHRASE: ${{ secrets.SEED_PHRASE }}
      METAMASK_PASSWORD: ${{ secrets.METAMASK_PASSWORD }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DYDX_MNEMONIC: ${{ secrets.DYDX_MNEMONIC }}
      DYDX_ADDRESS: ${{ secrets.DYDX_ADDRESS }}
      DYDX_NETWORK_TYPE: mainnet
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      DYDX_MNEMONIC_CANCEL_ORDER: ${{ secrets.DYDX_MNEMONIC_CANCEL_ORDER }}
      DYDX_ADDRESS_CANCEL_ORDER: ${{ secrets.DYDX_ADDRESS_CANCEL_ORDER }}
      SEED_PHRASE_CANCEL_ORDER: ${{ secrets.SEED_PHRASE_CANCEL_ORDER }}
      SEED_PHRASE_MEGAVAULT: ${{ secrets.SEED_PHRASE_MEGAVAULT }}
      AWS_DEFAULT_REGION:    ${{ secrets.AWS_DEFAULT_REGION }}
      S3_TRACE_BUCKET:       ${{ secrets.S3_TRACE_BUCKET }}

    outputs:
      slack_ts:       ${{ steps.slack_progress_message.outputs.message_ts }}
      needs_review:   ${{ steps.check-batch.outputs.needsReview }}
      found_batch_id: ${{ steps.check-batch.outputs.foundBatchID }}
      slack_channel:  ${{ env.SLACK_CHANNEL }}

    steps:
      # 1) Checkout E2E repo
      - name: Checkout E2E repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2) Checkout upstream v4-web for its tags
      - name: Checkout v4-web repository
        if: ${{ inputs.deployment_id != 'manual' }}
        uses: actions/checkout@v4
        with:
          repository: dydxprotocol/v4-web
          path:       v4-web
          fetch-depth: 0

      # 3) Identify latest release/vX.Y.Z on main
      - name: Identify latest production tag on main
        if: ${{ inputs.deployment_id != 'manual' }}
        id: prod-tag
        working-directory: v4-web
        run: |
          git fetch origin main --tags
          TAG=$(git tag --merged origin/main \
            | grep -E '^release/v[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V \
            | tail -n1)
          if [ -z "$TAG" ]; then
            echo "‚ùå No production tags found!" >&2
            exit 1
          fi
          echo "‚úîÔ∏è  Latest tag: $TAG"
          echo "production-tag=$TAG" >> $GITHUB_OUTPUT

      # 4) Prepare for tests
      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Node.js modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 5) Find existing Slack thread
      - name: Find Release Thread (if applicable)
        if: ${{ inputs.deployment_id != 'manual' }}
        id: find-thread
        run: |
          KEY=${{ steps.prod-tag.outputs.production-tag }}
          HISTORY=$(curl -s -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -G --data-urlencode "channel=$SLACK_CHANNEL" \
               --data-urlencode "limit=100" \
            https://slack.com/api/conversations.history)
          THREAD_TS=$(echo "$HISTORY" \
            | jq -r --arg key "$KEY" '
                .messages[]
                | select( .attachments? and (
                    [ .attachments[] | (.fallback//""),(.title//""),(.text//"") ]
                    | map(test($key; "i")) | any
                  ))
                | .ts
              ' | head -n1)
          if [ -n "$THREAD_TS" ]; then
            echo "thread_ts=$THREAD_TS" >> $GITHUB_OUTPUT
          fi

      # 6) Post initial Slack message
      - name: üèÅ Post Initial Progress to Slack
        id: slack_progress_message
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL:   ${{ env.SLACK_CHANNEL }}
          PARENT_THREAD_TS: ${{ steps.find-thread.outputs.thread_ts }}
          DISPLAY:         ${{ inputs.deployment_id == 'manual' && 'manual' || steps.prod-tag.outputs.production-tag }}
        run: |
          TEXT=$(
            printf "*E2E Pipeline for:* %s\n" "$DISPLAY"
            printf ">[‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 0%% | Initializing job...\n"
            printf "<%s|View full logs>\n" "$RUN_URL"
          )
          PAYLOAD=$(jq -n \
            --arg channel "$SLACK_CHANNEL" \
            --arg text "$TEXT" \
            '{channel: $channel, text: $text}')
          if [ -n "$PARENT_THREAD_TS" ]; then
            PAYLOAD=$(echo "$PAYLOAD" \
              | jq --arg ts "$PARENT_THREAD_TS" '. + {thread_ts: $ts}')
          fi
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            --data "$PAYLOAD" \
            https://slack.com/api/chat.postMessage)
          echo "message_ts=$(jq -r .ts <<<"$RESPONSE")" >> $GITHUB_OUTPUT

      # 7) Install dependencies
      - name: Install dependencies
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL:   ${{ env.SLACK_CHANNEL }}
          MESSAGE_TS:      ${{ steps.slack_progress_message.outputs.message_ts }}
          DISPLAY:         ${{ inputs.deployment_id == 'manual' && 'manual' || steps.prod-tag.outputs.production-tag }}
        run: |
          TEXT=$(
            printf "*E2E Pipeline for:* %s\n" "$DISPLAY"
            printf ">[‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë] 10%% | Installing dependencies...\n"
            printf "<%s|View full logs>\n" "$RUN_URL"
          )
          export MESSAGE_TEXT="$TEXT"
          scripts/update-slack-progress.sh
          npm install

      # 8) Run each test suite, updating Slack each time‚Ä¶
      - name: ‚ñ∫ Run Cancel-Order Tests
        continue-on-error: true
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL:   ${{ env.SLACK_CHANNEL }}
          MESSAGE_TS:      ${{ steps.slack_progress_message.outputs.message_ts }}
          DISPLAY:         ${{ inputs.deployment_id == 'manual' && 'manual' || steps.prod-tag.outputs.production-tag }}
        run: |
          TEXT=$(
            printf "*E2E Pipeline for:* %s\n" "$DISPLAY"
            printf ">[‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë] 20%% | Running Cancel-Order tests...\n"
            printf "<%s|View full logs>\n" "$RUN_URL"
          )
          export MESSAGE_TEXT="$TEXT"
          scripts/update-slack-progress.sh
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            npx playwright test --project=cancel-order-tests

      - name: ‚ñ∫ Run Megavault Tests
        continue-on-error: true
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL:   ${{ env.SLACK_CHANNEL }}
          MESSAGE_TS:      ${{ steps.slack_progress_message.outputs.message_ts }}
          DISPLAY:         ${{ inputs.deployment_id == 'manual' && 'manual' || steps.prod-tag.outputs.production-tag }}
        run: |
          TEXT=$(
            printf "*E2E Pipeline for:* %s\n" "$DISPLAY"
            printf ">[‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë] 40%% | Running Megavault tests...\n"
            printf "<%s|View full logs>\n" "$RUN_URL"
          )
          export MESSAGE_TEXT="$TEXT"
          scripts/update-slack-progress.sh
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            npx playwright test --project=megavault-tests

      - name: ‚ñ∫ Run Deposit/Withdraw Tests
        continue-on-error: true
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL:   ${{ env.SLACK_CHANNEL }}
          MESSAGE_TS:      ${{ steps.slack_progress_message.outputs.message_ts }}
          DISPLAY:         ${{ inputs.deployment_id == 'manual' && 'manual' || steps.prod-tag.outputs.production-tag }}
        run: |
          TEXT=$(
            printf "*E2E Pipeline for:* %s\n" "$DISPLAY"
            printf ">[‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë] 60%% | Running Deposit/Withdraw tests...\n"
            printf "<%s|View full logs>\n" "$RUN_URL"
          )
          export MESSAGE_TEXT="$TEXT"
          scripts/update-slack-progress.sh
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            npx playwright test --project=deposit-withdraw-tests

      - name: ‚ñ∫ Run Main Tests
        id: run-tests
        continue-on-error: true
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL:   ${{ env.SLACK_CHANNEL }}
          MESSAGE_TS:      ${{ steps.slack_progress_message.outputs.message_ts }}
          DISPLAY:         ${{ inputs.deployment_id == 'manual' && 'manual' || steps.prod-tag.outputs.production-tag }}
        run: |
          TEXT=$(
            printf "*E2E Pipeline for:* %s\n" "$DISPLAY"
            printf ">[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë] 80%% | Running remaining main tests...\n"
            printf "<%s|View full logs>\n" "$RUN_URL"
          )
          export MESSAGE_TEXT="$TEXT"
          scripts/update-slack-progress.sh
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            npx playwright test --project=main-tests --workers=2

      # 9) Sync report to S3
      - name: Sync full HTML report to S3
        if: always()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL:   ${{ env.SLACK_CHANNEL }}
          MESSAGE_TS:      ${{ steps.slack_progress_message.outputs.message_ts }}
          DISPLAY:         ${{ inputs.deployment_id == 'manual' && 'manual' || steps.prod-tag.outputs.production-tag }}
        run: |
          TEXT=$(
            printf "*E2E Pipeline for:* %s\n" "$DISPLAY"
            printf ">[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë] 90%% | Uploading HTML report to S3...\n"
            printf "<%s|View full logs>\n" "$RUN_URL"
          )
          export MESSAGE_TEXT="$TEXT"
          scripts/update-slack-progress.sh
          aws s3 sync playwright-report/ s3://${{ env.S3_TRACE_BUCKET }}/runs/${{ github.run_id }}/report/ --delete
          echo "REPORT_URL=https://${{ env.S3_TRACE_BUCKET }}.s3.${{ env.AWS_DEFAULT_REGION }}.amazonaws.com/runs/${{ github.run_id }}/report/index.html" >> $GITHUB_ENV

      # 10) Check Applitools
      - name: Check Applitools Batch
        id: check-batch
        if: always()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL:   ${{ env.SLACK_CHANNEL }}
          MESSAGE_TS:      ${{ steps.slack_progress_message.outputs.message_ts }}
          DISPLAY:         ${{ inputs.deployment_id == 'manual' && 'manual' || steps.prod-tag.outputs.production-tag }}
        run: |
          TEXT=$(
            printf "*E2E Pipeline for:* %s\n" "$DISPLAY"
            printf ">[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë] 95%% | Checking Applitools for visual diffs...\n"
            printf "<%s|View full logs>\n" "$RUN_URL"
          )
          export MESSAGE_TEXT="$TEXT"
          scripts/update-slack-progress.sh
          ./scripts/checkApplitoolsBatchByPointer.sh "$APPLITOOLS_SERVER_URL" "$APPLITOOLS_API_KEY" "$APPLITOOLS_BATCH_ID"

      # 11) Post final result
      - name: ‚úÖ Post Final Result to Slack
        if: always()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL:   ${{ env.SLACK_CHANNEL }}
          MESSAGE_TS:      ${{ steps.slack_progress_message.outputs.message_ts }}
          RUN_URL:         https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          REPORT_URL:      ${{ env.REPORT_URL }}
          DISPLAY:         ${{ inputs.deployment_id == 'manual' && 'manual' || steps.prod-tag.outputs.production-tag }}
        run: |
          set -e
          if [ "${{ steps.run-tests.outcome }}" != "success" ]; then
            HEADER="‚ùå E2E Tests Failed"
          elif [ "${{ steps.check-batch.outputs.needsReview }}" = "true" ]; then
            HEADER="‚ö†Ô∏è E2E Tests Passed with Visual Diffs"
          else
            HEADER="‚úÖ E2E Tests Passed"
          fi
          MESSAGE_TEXT=$(
            printf "%s\n" \
              "$HEADER" \
              "‚Ä¢ Deployment: $DISPLAY" \
              "‚Ä¢ <$RUN_URL|View GitHub Run>" \
              "‚Ä¢ <$REPORT_URL|View Full HTML Report>"
          )
          export MESSAGE_TEXT
          scripts/update-slack-progress.sh || true

      # 12) Upload artifact
      - name: Upload Test Report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: playwright-report/
          retention-days: 7

  applitools-auto-complete:
    name: "Applitools Auto-Completion"
    if: needs.e2e-test.outputs.needs_review == 'false'
    needs: e2e-test
    runs-on: ubuntu-latest
    env:
      SLACK_CHANNEL:      ${{ needs.e2e-test.outputs.slack_channel }}
      ROOT_THREAD_TS:     ${{ needs.e2e-test.outputs.slack_ts }}
      SLACK_BOT_TOKEN:    ${{ secrets.SLACK_BOT_TOKEN }}
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
    steps:
      - name: Mark Applitools Batch as Complete
        run: |
          curl -X POST -d '' \
            -H 'accept:*/*' \
            "$APPLITOOLS_SERVER_URL/api/externals/github/servers/github.com/commit/${{ needs.e2e-test.outputs.found_batch_id }}/complete?apiKey=$APPLITOOLS_API_KEY"
      - name: Post Slack Thread (All Passed)
        run: |
          APPLITOOLS_LINK="https://eyes.applitools.com/app/test-results/${{ needs.e2e-test.outputs.found_batch_id }}/"
          GITHUB_RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          MSG="Additional details posted:\n‚Ä¢ <${APPLITOOLS_LINK}|View Applitools Batch>\n‚Ä¢ <${GITHUB_RUN_URL}|View GitHub Action>"
          jq -n \
            --arg channel "${{ needs.e2e-test.outputs.slack_channel }}" \
            --arg ts "${{ needs.e2e-test.outputs.slack_ts }}" \
            --arg text "$MSG" \
            '{channel: $channel, thread_ts: $ts, text: $text}' \
          | curl -s -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              --data @- \
              https://slack.com/api/chat.postMessage

  batch-status-polling:
    name: "Applitools Batch Status Polling"
    if: needs.e2e-test.outputs.needs_review == 'true'
    needs: e2e-test
    runs-on: ubuntu-latest
    env:
      SLACK_CHANNEL:      ${{ needs.e2e-test.outputs.slack_channel }}
      ROOT_THREAD_TS:     ${{ needs.e2e-test.outputs.slack_ts }}
      SLACK_BOT_TOKEN:    ${{ secrets.SLACK_BOT_TOKEN }}
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - name: Poll Applitools Batch Status
        id: poll-status
        run: |
          send_slack_message() { ‚Ä¶ }

          APPLITOOLS_LINK="https://eyes.applitools.com/app/test-results/${{ needs.e2e-test.outputs.found_batch_id }}/"
          GITHUB_RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          MAX=120; INTERVAL=30; i=0; STATUS=""
          while (( i < MAX )); do
            (( i++ ))
            START=$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ)
            END=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            resp=$(curl -s -H "X-Eyes-Api-Key: $APPLITOOLS_API_KEY" \
                  "${APPLITOOLS_SERVER_URL}/api/v1/batches?start=${START}&end=${END}&pageSize=100")

            B=$(jq --arg bid "${{ needs.e2e-test.outputs.found_batch_id }}" \
                  '.batches[] | select(.id==$bid)' \
                <<<"$resp")

            # If batch not yet found, retry:
            if [[ -z "$B" || "$B" == "null" ]]; then
              sleep $INTERVAL
              continue
            fi

            # Now we know B is non-empty real JSON
            F=$(echo "$B" | jq -r '.runningSummary.failedTests // 0')
            U=$(echo "$B" | jq -r '.runningSummary.unresolvedTests // 0')
            N=$(echo "$B" | jq -r '.runningSummary.newTests // 0')

            if (( F > 0 )); then
              STATUS="FAILED"; break
            elif (( F==0 && U==0 && N==0 )); then
              STATUS="PASSED"; break
            else
              sleep $INTERVAL
            fi
          done

          if [[ "$STATUS" == "PASSED" ]]; then
            send_slack_message "‚úÖ *Visual Review Approved* üéâ\nRollout can proceed.\n<${RUN_URL}|View Action> | <${APPLITOOLS_SERVER_URL}/app/test-results/${{ needs.e2e-test.outputs.found_batch_id }}/|View Applitools>" || true
            echo "status=approved" >> $GITHUB_OUTPUT
          elif [[ "$STATUS" == "FAILED" ]]; then
            send_slack_message "‚ùå *Visual Review Rejected* üö®\nRollout stopped.\n<${RUN_URL}|View Action> | <${APPLITOOLS_SERVER_URL}/app/test-results/${{ needs.e2e-test.outputs.found_batch_id }}/|View Applitools>" || true
            echo "status=rejected" >> $GITHUB_OUTPUT
          else
            send_slack_message "‚ö†Ô∏è *Review Timed Out* ‚è≥\nStill unresolved after 1 hour. Please check manually.\n<${RUN_URL}|View Action> | <${APPLITOOLS_SERVER_URL}/app/test-results/${{ needs.e2e-test.outputs.found_batch_id }}/|View Applitools>" || true
            echo "status=timeout" >> $GITHUB_OUTPUT
          fi

      - name: Mark Applitools Batch as Complete
        if: steps.poll-status.outputs.status == 'approved'
        run: |
          curl -X POST -d '' \
            -H 'accept:*/*' \
            "$APPLITOOLS_SERVER_URL/api/externals/github/servers/github.com/commit/${{ needs.e2e-test.outputs.found_batch_id }}/complete?apiKey=$APPLITOOLS_API_KEY"

      - name: Fail Workflow if Review Rejected
        if: steps.poll-status.outputs.status == 'rejected'
        run: exit 1
