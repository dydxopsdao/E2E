name: E2E Pipeline

on:
  workflow_dispatch:
    inputs:
      deployment_id:
        description: 'Deployment ID'
        required: false
        default: 'manual'
  pull_request:

env:
  APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  APPLITOOLS_SERVER_URL: https://eyesapi.applitools.com

jobs:
  e2e-test:
    name: "E2E Tests (Deployment: ${{ inputs.deployment_id }})"
    runs-on: self-hosted

    env:
      APPLITOOLS_BATCH_ID: ${{ github.event.pull_request.head.sha || github.sha }}
      SLACK_CHANNEL: ${{ inputs.deployment_id == 'manual' && '#test-channel' || 'C07VDF07WLU' }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      NORDLAYER_EMAIL: ${{ secrets.NORDLAYER_EMAIL }}
      NORDLAYER_PASSWORD: ${{ secrets.NORDLAYER_PASSWORD }}
      SEED_PHRASE: ${{ secrets.SEED_PHRASE }}
      METAMASK_PASSWORD: ${{ secrets.METAMASK_PASSWORD }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DYDX_MNEMONIC: ${{ secrets.DYDX_MNEMONIC }}
      DYDX_ADDRESS: ${{ secrets.DYDX_ADDRESS }}
      DYDX_NETWORK_TYPE: mainnet
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      DYDX_MNEMONIC_CANCEL_ORDER: ${{ secrets.DYDX_MNEMONIC_CANCEL_ORDER }}
      DYDX_ADDRESS_CANCEL_ORDER: ${{ secrets.DYDX_ADDRESS_CANCEL_ORDER }}
      SEED_PHRASE_CANCEL_ORDER: ${{ secrets.SEED_PHRASE_CANCEL_ORDER }}
      SEED_PHRASE_MEGAVAULT: ${{ secrets.SEED_PHRASE_MEGAVAULT }}
      AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION:    ${{ secrets.AWS_DEFAULT_REGION }}
      S3_TRACE_BUCKET:       ${{ secrets.S3_TRACE_BUCKET }}

    outputs:
      root_thread_ts: ${{ steps.find-thread-diagnostic.outputs.thread_ts }}
      slack_ts:       ${{ steps.slack-notify.outputs.slack_ts }}
      needs_review:   ${{ steps.check-batch.outputs.needsReview }}
      found_batch_id: ${{ steps.check-batch.outputs.foundBatchID }}
      slack_channel:  ${{ env.SLACK_CHANNEL }}

    steps:
      - uses: actions/checkout@v4
        name: Checkout repository
        with:
          token: ${{ secrets.GH_PAT_FOR_CHECKOUT }}
          fetch-depth: 5

      - name: Install dependencies
        run: npm install
        env:
          PLAYWRIGHT_BROWSERS_PATH: /opt/playwright

      - name: Find Release Thread (DIAGNOSTIC)
        id: find-thread-diagnostic
        if: ${{ inputs.deployment_id != 'manual' }}
        run: |
          echo "::group::Slack history diagnostic for ID=${{ inputs.deployment_id }}"
          HISTORY=$(curl --fail -s \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -G --data-urlencode "channel=$SLACK_CHANNEL" \
               --data-urlencode "limit=100" \
            https://slack.com/api/conversations.history)
          echo "::endgroup::"

          THREAD_TS=$(echo "$HISTORY" | jq -r --arg id "${{ inputs.deployment_id }}" '
            .messages[]
            | select(
                .attachments? and (
                  [ .attachments[] 
                      | (.fallback // ""), (.title // ""), (.pretext // ""), (.text // "")
                  ] | map(test($id; "i")) | any
                )
              )
            | .ts
          ' | head -1)

          if [ -n "$THREAD_TS" ]; then
            echo "thread_ts=$THREAD_TS" >> $GITHUB_OUTPUT
            echo "THREAD_TS=$THREAD_TS" >> $GITHUB_ENV
          else
            echo "::warning::no matching release message in last 100"
          fi

      - name: Post ‚ÄúTests started‚Äù to Slack
        id: slack-started
        if: ${{ inputs.deployment_id != 'manual' && env.THREAD_TS }}
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TEXT="üèÅ E2E tests started for **Deployment ID:** ${{ inputs.deployment_id }}\nüîó [View run logs]($RUN_URL)"
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            --data "{\"channel\":\"$SLACK_CHANNEL\",\"thread_ts\":\"$THREAD_TS\",\"text\":\"$TEXT\"}" \
            https://slack.com/api/chat.postMessage)
          echo "ts=$(echo \"$RESPONSE\" | jq -r .ts)" >> $GITHUB_OUTPUT

      - name: Run E2E Tests (Playwright + Applitools)
        id: run-tests
        continue-on-error: true
        env:
          DEPLOYMENT_ID: ${{ inputs.deployment_id }}
        run: |
          PLAYWRIGHT_JUNIT_OUTPUT=results.xml xvfb-run --auto-servernum \
            --server-args='-screen 0 1920x1080x24' \
            npx playwright test --grep "Connect MetaMask Wallet" --workers=2 --trace on --reporter=html

      - name: Upload Test Report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-report-${{ github.run_id }}
          path: playwright-report/

      - name: Configure AWS via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::221082214510:role/GitHubActionsS3Publisher
          aws-region:    ${{ secrets.AWS_DEFAULT_REGION }}

      - name: Sync HTML report to S3
        if: always()
        run: |
          aws s3 sync playwright-report/ \
            s3://${{ secrets.S3_TRACE_BUCKET }}/runs/${{ github.run_id }}/report/ \
            --delete
          echo "REPORT_URL=http://${{ secrets.S3_TRACE_BUCKET }}.s3-website.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/runs/${{ github.run_id }}/report/index.html" \
            >> $GITHUB_ENV

      - name: Sync Playwright traces to S3
        if: always()
        run: |
          aws s3 sync playwright-report/trace/ \
            s3://${{ secrets.S3_TRACE_BUCKET }}/runs/${{ github.run_id }}/trace/ \
            --delete
          echo "TRACE_BASE_URL=http://${{ secrets.S3_TRACE_BUCKET }}.s3-website.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/runs/${{ github.run_id }}/trace" \
            >> $GITHUB_ENV

      - name: Export URLs
        if: always()
        run: |
          echo "REPORT_URL=http://${{ secrets.S3_TRACE_BUCKET }}.s3-website.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/runs/${{ github.run_id }}/report/index.html" >> $GITHUB_ENV
          echo "TRACE_BASE_URL=http://${{ secrets.S3_TRACE_BUCKET }}.s3-website.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/runs/${{ github.run_id }}/trace" >> $GITHUB_ENV

      - name: Check Applitools Batch By Pointer
        id: check-batch
        if: always()
        run: |
          chmod +x scripts/checkApplitoolsBatchByPointer.sh
          ./scripts/checkApplitoolsBatchByPointer.sh \
            "$APPLITOOLS_SERVER_URL" \
            "$APPLITOOLS_API_KEY" \
            "$APPLITOOLS_BATCH_ID"

      - name: Post Slack Notification (Main Message)
        id: slack-notify
        if: always()
        run: |
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          OUTCOME="${{ steps.run-tests.outcome }}"
          APPLITOOLS_LINK="https://eyes.applitools.com/app/test-results/${{ steps.check-batch.outputs.foundBatchID }}/"

          if [ "$OUTCOME" != "success" ]; then
            TEXT="‚ùå E2E tests ${OUTCOME}! (**Deployment ID:** ${{ inputs.deployment_id }})\nüîó [View logs]($RUN_URL)"
          else
            if [ "${{ steps.check-batch.outputs.needsReview }}" = "true" ]; then
              TEXT="‚úÖ E2E tests passed! üîç *Visual diffs detected ‚Äì manual review needed.*\nüîó [Review in Applitools]($APPLITOOLS_LINK)\nüîó [Run details]($RUN_URL)"
            else
              TEXT="‚úÖ E2E tests passed! (**Deployment ID:** ${{ inputs.deployment_id }})\nüéâ Rollout can proceed.\nüîó [Run details]($RUN_URL)"
            fi
          fi

          [ -n "$REPORT_URL"   ] && TEXT="${TEXT}\nüìë [View HTML report]($REPORT_URL)"
          [ -n "$TRACE_BASE_URL" ] && TEXT="${TEXT}\nüîç [Browse raw traces]($TRACE_BASE_URL/index.html)"

          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            --data "{\"channel\":\"$SLACK_CHANNEL\",\"thread_ts\":\"$THREAD_TS\",\"text\":\"$TEXT\"}" \
            https://slack.com/api/chat.postMessage

  applitools-auto-complete:
    name: "Applitools Auto-Completion"
    if: needs.e2e-test.outputs.needs_review == 'false'
    needs: e2e-test
    runs-on: ubuntu-latest
    env:
      SLACK_CHANNEL:      ${{ needs.e2e-test.outputs.slack_channel }}
      ROOT_THREAD_TS:     ${{ needs.e2e-test.outputs.root_thread_ts }}
      SLACK_BOT_TOKEN:    ${{ secrets.SLACK_BOT_TOKEN }}
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
    steps:
      - name: Mark Applitools Batch as Complete
        run: |
          curl -X POST -d '' -H 'accept:*/*' \
            "$APPLITOOLS_SERVER_URL/api/externals/github/servers/github.com/commit/${{ needs.e2e-test.outputs.found_batch_id }}/complete?apiKey=$APPLITOOLS_API_KEY"
      - name: Post Slack Thread (All Passed)
        run: |
          THREAD_TS="$ROOT_THREAD_TS"
          APPLITOOLS_LINK="https://eyes.applitools.com/app/test-results/${{ needs.e2e-test.outputs.found_batch_id }}/"
          GITHUB_RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          MSG="Additional details:\n- GitHub Action: ${GITHUB_RUN_URL}\n- Applitools: ${APPLITOOLS_LINK}"
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            --data "{\"channel\":\"$SLACK_CHANNEL\",\"thread_ts\":\"$THREAD_TS\",\"text\":\"$MSG\"}" \
            https://slack.com/api/chat.postMessage

  batch-status-polling:
    name: "Applitools Batch Status Polling"
    if: needs.e2e-test.outputs.needs_review == 'true'
    needs: e2e-test
    runs-on: ubuntu-latest
    env:
      SLACK_CHANNEL:      ${{ needs.e2e-test.outputs.slack_channel }}
      ROOT_THREAD_TS:     ${{ needs.e2e-test.outputs.root_thread_ts }}
      SLACK_BOT_TOKEN:    ${{ secrets.SLACK_BOT_TOKEN }}
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Poll Applitools Batch Status
        id: poll-status
        run: |
          send_slack_message() {
            local msg="$1"
            esc=$(echo "$msg" | sed 's/"/\\"/g')
            curl -s -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              --data "{\"channel\":\"$SLACK_CHANNEL\",\"thread_ts\":\"$ROOT_THREAD_TS\",\"text\":\"$esc\"}" \
              https://slack.com/api/chat.postMessage
          }

          APPLITOOLS_LINK="https://eyes.applitools.com/app/test-results/${{ needs.e2e-test.outputs.found_batch_id }}/"
          GITHUB_RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          # initial pending notification
          send_slack_message "‚ö†Ô∏è **Visual differences detected**  
            üîç *Waiting for manual review‚Ä¶*  
            [Review in Applitools](${APPLITOOLS_LINK})  
            ‚è≥ Monitoring up to 1 h."

          MAX=120
          INTERVAL=30
          i=0
          STATUS=""

          while (( i < MAX )); do
            ((i++))
            START=$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ)
            END=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            resp=$(curl -s -H "X-Eyes-Api-Key: $APPLITOOLS_API_KEY" \
              "${APPLITOOLS_SERVER_URL}/api/v1/batches?start=${START}&end=${END}&pageSize=100")
            B=$(echo "$resp" | jq --arg bid "${{ needs.e2e-test.outputs.found_batch_id }}" \
                  '.batches[] | select(.id==$bid)')
            if [[ -z "$B" || "$B" == "null" ]]; then
              sleep "$INTERVAL"
              continue
            fi

            F=$(echo "$B" | jq -r '.runningSummary.failedTests // 0')
            U=$(echo "$B" | jq -r '.runningSummary.unresolvedTests // 0')
            N=$(echo "$B" | jq -r '.runningSummary.newTests      // 0')

            if (( F > 0 )); then
              STATUS="FAILED"
              break
            elif (( F==0 && U==0 && N==0 )); then
              STATUS="PASSED"
              break
            else
              sleep "$INTERVAL"
            fi
          done

          if [[ "$STATUS" == "PASSED" ]]; then
            send_slack_message "‚úÖ **Visual Review Approved**  
            üéâ Rollout can proceed.  
            üîó [Action](${GITHUB_RUN_URL}) | [Applitools](${APPLITOOLS_LINK})"
            echo "status=approved" >> $GITHUB_OUTPUT
          elif [[ "$STATUS" == "FAILED" ]]; then
            send_slack_message "‚ùå **Visual Review Rejected**  
            üö® Rollout stopped.  
            üîó [Action](${GITHUB_RUN_URL}) | [Applitools](${APPLITOOLS_LINK})"
            echo "status=rejected" >> $GITHUB_OUTPUT
          else
            send_slack_message "‚ö†Ô∏è **Review timed out**  
            ‚è≥ Still unresolved after 1‚ÄÜh‚Äîplease check manually.  
            üîó [Action](${GITHUB_RUN_URL}) | [Applitools](${APPLITOOLS_LINK})"
            echo "status=timeout" >> $GITHUB_OUTPUT
          fi

      - name: Mark Applitools Batch as Complete
        if: steps.poll-status.outputs.status == 'approved'
        run: |
          curl -X POST -d '' -H 'accept:*/*' \
            "$APPLITOOLS_SERVER_URL/api/externals/github/servers/github.com/commit/${{ needs.e2e-test.outputs.found_batch_id }}/complete?apiKey=$APPLITOOLS_API_KEY"

      - name: Fail Workflow if Review Rejected
        if: steps.poll-status.outputs.status == 'rejected'
        run: exit 1
